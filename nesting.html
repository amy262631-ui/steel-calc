<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§æ’æ–™èˆ‡é‡é‡è¨ˆç®—ç³»çµ± V16.2 - æ——è‰¦ç‰ˆ</title>
    <link rel="canonical" href="https://steel-calc.idv.tw/nesting.html" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/makerjs@0.18.0/target/js/browser.maker.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', "Microsoft JhengHei", sans-serif; background: #f1f5f9; }
        .tab-active { background: white; color: #2563eb; border-bottom: 3px solid #2563eb; font-weight: 900; }
        .input-group:hover { border-color: #3b82f6; }
        .canvas-container { filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.05)); }
        select { cursor: pointer; }
        .stock-bar { height: 50px; border-radius: 12px; overflow: hidden; display: flex; align-items: center; background: #e2e8f0; border: 2px solid #cbd5e1; }
        .cut-segment { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 900; border-right: 1px solid rgba(255,255,255,0.4); color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3); transition: all 0.2s; }
        .cut-segment:hover { opacity: 0.9; transform: scaleY(1.05); cursor: help; }
        .back-link { display: inline-flex; align-items: center; gap: 8px; color: #64748b; font-weight: 900; font-size: 14px; transition: all 0.2s; text-decoration: none; }
        .back-link:hover { color: #2563eb; transform: translateX(-4px); }
    </style>
</head>
<body class="min-h-screen pb-20">

<div class="max-w-7xl mx-auto px-4 pt-4">
    <a href="index.html" class="back-link">â† è¿”å›åŸºç¤é‡é‡è¨ˆç®—æ©Ÿ</a>
</div>

<div class="max-w-7xl mx-auto px-4 pt-6">
    <div class="flex gap-4 mb-6 bg-slate-200 p-1.5 rounded-2xl w-fit">
        <button onclick="switchTab('plate')" id="tab-plate" class="px-8 py-3 rounded-xl transition-all tab-active">ğŸ§± éµæ¿æ’æ–™</button>
        <button onclick="switchTab('steel')" id="tab-steel" class="px-8 py-3 rounded-xl transition-all text-slate-500 font-bold">ğŸ—ï¸ å‹é‹¼é…æ–™</button>
    </div>

    <div id="section-plate" class="space-y-8 animate-in fade-in">
        <div class="max-w-7xl mx-auto">
            <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-[2.5rem] p-8 md:p-12 shadow-2xl border border-slate-700 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-orange-500/10 rounded-full -mr-16 -mt-16 blur-2xl"></div>
                <div class="relative z-10 mb-10">
                    <h2 class="text-white text-3xl font-black mb-4 flex items-center gap-3">
                        <span class="bg-orange-500 p-2 rounded-xl text-2xl">ğŸ§±</span> ç‚ºä»€éº¼éœ€è¦æ™ºæ…§æ’æ–™ï¼Ÿ
                    </h2>
                    <p class="text-slate-300 text-lg leading-relaxed max-w-3xl">
                        æ—¨åœ¨é€é <b>2D å¹¾ä½•æ¼”ç®—</b>ï¼Œåœ¨æœ€çŸ­æ™‚é–“å…§å°‹æ‰¾æœ€ä½³æ“ºæ”¾è§’åº¦ï¼Œé”åˆ°<span class="text-orange-400 font-bold">ã€Œå‰©æ–™æœ€å°åŒ–ã€</span>çš„ç›®çš„ï¼Œå¤§å¹…ç¯€çœé«˜æ˜‚çš„æ¿ææˆæœ¬ã€‚
                    </p>
                </div>
                <div class="grid md:grid-cols-3 gap-8 relative z-10 border-t border-slate-700/50 pt-8 text-sm">
                    <div class="space-y-1"><p class="text-white font-bold">Step 1. è¨­å®šæ¯æ¿</p><p class="text-slate-400">è¼¸å…¥ç¾æœ‰æ¿æå°ºå¯¸ã€‚</p></div>
                    <div class="space-y-1"><p class="text-white font-bold">Step 2. åŒ¯å…¥é›¶ä»¶</p><p class="text-slate-400">å¡«å…¥å„è™Ÿé›¶ä»¶é•·å¯¬èˆ‡æ•¸é‡ã€‚</p></div>
                    <div class="space-y-1"><p class="text-white font-bold">Step 3. è‡ªå‹•æè€—</p><p class="text-slate-400">ç³»çµ±å·²è‡ªå‹•é ç•™ <span class="text-orange-400 font-bold">15mm é‹¸ç¸«</span>ã€‚</p></div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-3xl p-8 shadow-sm border border-slate-200">
            <h1 class="text-3xl font-black text-slate-900 mb-6">æ¥åˆæ¿éµæ¿æ™ºæ…§æ’æ–™</h1>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8 text-center">
                <div class="bg-blue-600 p-5 rounded-3xl text-white"><p class="text-[10px] font-black uppercase mb-1">ç¸½é‡é‡</p><p class="text-3xl font-black"><span id="p-total-weight">0.00</span> kg</p></div>
                <div class="bg-white p-5 rounded-3xl border border-slate-200"><p class="text-[10px] font-black uppercase mb-1">ç¸½å¼µæ•¸</p><p id="p-total-sheets" class="text-3xl font-black">0</p></div>
                <div class="bg-emerald-500 p-5 rounded-3xl text-white"><p class="text-[10px] font-black uppercase mb-1">åˆ©ç”¨ç‡</p><p id="p-avg-util" class="text-3xl font-black">0%</p></div>
                <div class="bg-slate-900 p-5 rounded-3xl text-white"><p class="text-[10px] font-black uppercase mb-1">é›¶ä»¶é–“è·</p><p class="text-2xl font-black text-amber-400">15.0 mm</p></div>
            </div>
            <div id="p-input-rows" class="space-y-3"></div>
            <button onclick="addRowPlate()" class="mt-4 text-blue-600 font-black text-sm bg-blue-50 px-6 py-3 rounded-2xl border border-blue-100">+ æ–°å¢éµæ¿æ¸…å–®</button>
        </div>
        <div id="p-output" class="space-y-12"></div>
    </div>

    <div id="section-steel" class="hidden space-y-8 animate-in slide-in-from-right duration-500">
        <div class="max-w-7xl mx-auto">
            <div class="bg-gradient-to-br from-indigo-900 to-slate-900 rounded-[2.5rem] p-8 md:p-12 shadow-2xl border border-indigo-800/30 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/10 rounded-full -mr-16 -mt-16 blur-2xl"></div>
                <div class="relative z-10 mb-10">
                    <h2 class="text-white text-3xl font-black mb-4 flex items-center gap-3">
                        <span class="bg-blue-500 p-2 rounded-xl text-2xl">ğŸ—ï¸</span> æ™ºæ…§é…æ–™ï¼šå‘Šåˆ¥æ‰‹å·¥è©¦ç®—
                    </h2>
                    <p class="text-slate-300 text-lg leading-relaxed max-w-3xl">
                        åˆ©ç”¨ <b>ä¸€ç¶­ç·šæ€§å„ªåŒ–æ¼”ç®—æ³•</b>ï¼Œè‡ªå‹•è¨ˆç®—å¦‚ä½•ç”¨æœ€å°‘çš„æ¯æçµ„åˆæœ€å¤šçš„é›¶ä»¶ï¼Œå°‡æ˜‚è²´çš„å‹é‹¼æ®˜æ–™é™è‡³æ¥µçŸ­ï¼Œé”åˆ°<span class="text-blue-400 font-bold">ã€Œå–ä»£æ‰‹å·¥åŠ æ¸›æ³•ã€</span>èˆ‡<span class="text-blue-400 font-bold">ã€Œæ¸›å°‘å‚™æ–™å¤±èª¤ã€</span>çš„ç›®çš„ã€‚
                    </p>
                </div>
                <div class="grid md:grid-cols-3 gap-8 relative z-10 border-t border-slate-700/50 pt-8 text-sm">
                    <div class="space-y-1"><p class="text-white font-bold">Step 1. é¸å–è¦æ ¼</p><p class="text-slate-400">è¨­å®šå®šå°ºé•·åº¦ï¼ˆå¦‚ 6M æˆ– 12Mï¼‰ã€‚</p></div>
                    <div class="space-y-1"><p class="text-white font-bold">Step 2. è¼¸å…¥æ¸…å–®</p><p class="text-slate-400">å¡«å…¥åˆ‡æ–·é•·åº¦ï¼Œç›¸åŒå°ºå¯¸è‡ªå‹•åˆ†è‰²ã€‚</p></div>
                    <div class="space-y-1"><p class="text-white font-bold">Step 3. ç²¾ç¢ºæè€—</p><p class="text-slate-400">å·²è‡ªå‹•æ‰£é™¤ <span class="text-blue-400 font-bold">15mm é‹¸åºŠæè€—</span>ã€‚</p></div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-3xl p-8 shadow-sm border border-slate-200">
            <h1 class="text-3xl font-black text-slate-900 mb-6">å‹é‹¼æ™ºæ…§é…æ–™</h1>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8 text-center">
                <div class="bg-indigo-600 p-5 rounded-3xl text-white"><p class="text-[10px] font-black uppercase mb-1">å‹é‹¼ç¸½é‡é‡</p><p class="text-3xl font-black"><span id="s-total-weight">0.00</span> kg</p></div>
                <div class="bg-white p-5 rounded-3xl border border-slate-200"><p class="text-[10px] font-black uppercase mb-1">æ¶ˆè€—æ”¯æ•¸</p><p id="s-total-bars" class="text-3xl font-black text-slate-900">0</p></div>
                <div class="bg-slate-900 p-5 rounded-3xl text-white"><p class="text-[10px] font-black uppercase mb-1">é‹¸ç¸«æè€—</p><p class="text-xl font-black text-emerald-400">15.0 mm</p></div>
            </div>
            <div id="s-input-rows" class="space-y-3"></div>
            <button onclick="addRowSteel()" class="mt-4 text-indigo-600 font-black text-sm bg-indigo-50 px-6 py-3 rounded-2xl border border-indigo-100">+ æ–°å¢å‹é‹¼æ¸…å–®</button>
        </div>
        <div id="s-output" class="space-y-12 text-center"></div>
    </div>
</div>

<script>
    const STEEL_DB = {
        "Hå‹é‹¼": [ { n: "H350x350", w: 137 }, { n: "H300x300", w: 94.0 }, { n: "H250x250", w: 72.4 }, { n: "H200x200", w: 49.9 }, { n: "H150x150", w: 31.5 }, { n: "H100x100", w: 17.2 }, { n: "H300x150", w: 36.7 } ],
        "æ§½éµ": [ { n: "75x40x5x7", w: 6.92 }, { n: "150x75x6.5x10", w: 18.6 }, { n: "300x90x9x13", w: 38.1 } ],
        "éµç®¡": [ { n: "1\"(34)x2.6", w: 2.01 }, { n: "4\"(115)x4.5", w: 12.3 }, { n: "12\"(318.5)x6", w: 46.2 } ]
    };

    const CONFIG_P = { GAP: 15.0, MARGIN: 15.0 };

    window.onload = () => { addRowPlate(3); addRowSteel(); };

    function switchTab(t) {
        document.getElementById('section-plate').classList.toggle('hidden', t !== 'plate');
        document.getElementById('section-steel').classList.toggle('hidden', t !== 'steel');
        document.getElementById('tab-plate').className = t === 'plate' ? 'px-8 py-3 rounded-xl transition-all tab-active' : 'px-8 py-3 rounded-xl transition-all text-slate-500 font-bold';
        document.getElementById('tab-steel').className = t === 'steel' ? 'px-8 py-3 rounded-xl transition-all tab-active' : 'px-8 py-3 rounded-xl transition-all text-slate-500 font-bold';
    }

    // --- éµæ¿é‚è¼¯ ---
    function addRowPlate(lastT = 3) {
        const container = document.getElementById('p-input-rows');
        const rowId = Date.now();
        const row = document.createElement('div');
        row.className = "grid grid-cols-12 gap-3 items-end p-5 bg-slate-50 rounded-2xl border border-slate-200 input-group transition-all";
        row.innerHTML = `
            <div class="col-span-1 text-center font-black text-blue-500 p-row-no italic">#</div>
            <div class="col-span-2"><select class="w-full bg-white border p-3 rounded-xl font-bold p-part-t">${Array.from({length:50},(_,i)=>`<option value="${i+1}" ${i+1==lastT?'selected':''}>${i+1}t</option>`).join('')}</select></div>
            <div class="col-span-3"><input type="number" placeholder="é•·åº¦" class="w-full bg-white border p-3 rounded-xl font-bold p-part-l"></div>
            <div class="col-span-3"><input type="number" placeholder="å¯¬åº¦" class="w-full bg-white border p-3 rounded-xl font-bold p-part-w"></div>
            <div class="col-span-2"><input type="number" placeholder="æ•¸é‡" class="w-full bg-white border p-3 rounded-xl font-bold p-part-q"></div>
            <div class="col-span-1 flex justify-end"><button onclick="this.parentElement.parentElement.remove(); calculatePlate();" class="text-slate-300 hover:text-red-500 text-2xl">Ã—</button></div>`;
        container.appendChild(row);
        row.querySelectorAll('input, select').forEach(el => el.addEventListener('input', calculatePlate));
    }

    function calculatePlate() {
        const d = parseFloat(document.getElementById('p-material').value);
        let grouped = {}, totalW = 0;
        document.querySelectorAll('#p-input-rows .input-group').forEach((row, idx) => {
            const T = parseFloat(row.querySelector('.p-part-t').value);
            const L = parseFloat(row.querySelector('.p-part-l').value) || 0;
            const W = parseFloat(row.querySelector('.p-part-w').value) || 0;
            const Q = parseInt(row.querySelector('.p-part-q').value) || 0;
            if(L>0 && W>0 && Q>0) {
                totalW += (L*W*T*d)/1000000 * Q;
                if(!grouped[T]) grouped[T] = [];
                for(let i=0;i<Q;i++) grouped[T].push({id: idx+1, w:L, h:W});
            }
        });
        document.getElementById('p-total-weight').textContent = totalW.toFixed(2);
        renderPlate(grouped);
    }

    function renderPlate(grouped) {
        const out = document.getElementById('p-output'); out.innerHTML = "";
        const bh_bw = document.getElementById('p-board-spec').value.split(',');
        const bh = parseInt(bh_bw[0]), bw = parseInt(bh_bw[1]);
        Object.keys(grouped).forEach(t => {
            const res = nest2D(grouped[t], bw, bh);
            const sec = document.createElement('div');
            sec.innerHTML = `<h2 class="text-2xl font-black mb-4 border-l-4 border-blue-600 pl-4">${t}mm æ¿ææ’æ–™åœ–</h2><div id="p-t-${t}"></div>`;
            out.appendChild(sec);
            res.forEach((sheet, si) => {
                const cv = document.createElement('canvas');
                const sc = 0.2; cv.width = bw*sc; cv.height = bh*sc;
                cv.className = "bg-white border-2 border-slate-800 mb-4";
                const ctx = cv.getContext('2d');
                sheet.forEach(p => {
                    ctx.fillStyle = "#3b82f6"; ctx.fillRect(p.x*sc, p.y*sc, p.w*sc, p.h*sc);
                    ctx.strokeStyle = "white"; ctx.strokeRect(p.x*sc, p.y*sc, p.w*sc, p.h*sc);
                });
                document.getElementById(`p-t-${t}`).appendChild(cv);
            });
        });
    }

    function nest2D(parts, bw, bh) {
        let sorted = [...parts].sort((a,b)=>b.w*b.h - a.w*a.h);
        let sheets = [];
        while(sorted.length > 0){
            let pl = [], sky = new Array(Math.ceil(bw)).fill(CONFIG_P.MARGIN);
            for(let i=0; i<sorted.length; i++){
                let p = sorted[i];
                let res = findPos(p.w, p.h, sky, bw, bh);
                if(res){
                    pl.push({...p, x:res.x, y:res.y});
                    for(let x=Math.floor(res.x);x<Math.min(bw, Math.ceil(res.x+p.w));x++) sky[x]=res.y+p.h+CONFIG_P.GAP;
                    sorted.splice(i,1); i--;
                }
            }
            sheets.push(pl);
        }
        return sheets;
    }

    function findPos(pw, ph, sky, bw, bh){
        let by = Infinity, bx = -1;
        for(let x=CONFIG_P.MARGIN; x+pw+CONFIG_P.MARGIN <= bw; x+=10){
            let cy = CONFIG_P.MARGIN;
            for(let sx=Math.floor(x); sx<x+pw; sx++) cy = Math.max(cy, sky[sx]);
            if(cy+ph+CONFIG_P.MARGIN <= bh && cy < by){ by = cy; bx = x; }
        }
        return bx !== -1 ? {x:bx, y:by} : null;
    }

    // --- å‹é‹¼é‚è¼¯ (å·²åŠ å…¥ 15mm é‹¸ç¸«ä¿®æ­£) ---
    function addRowSteel() {
        const container = document.getElementById('s-input-rows');
        const row = document.createElement('div');
        row.className = "grid grid-cols-12 gap-3 items-end p-5 bg-slate-50 rounded-2xl border input-group transition-all";
        let specOpts = "";
        Object.keys(STEEL_DB).forEach(cat => {
            specOpts += `<optgroup label="${cat}">${STEEL_DB[cat].map(s=>`<option value="${s.w}" data-name="${s.n}">${s.n}</option>`).join('')}</optgroup>`;
        });
        row.innerHTML = `
            <div class="col-span-1 text-center font-black text-indigo-500 italic">#</div>
            <div class="col-span-4"><select class="w-full bg-white border p-3 rounded-xl font-bold s-part-spec">${specOpts}</select></div>
            <div class="col-span-3"><input type="number" placeholder="åˆ‡æ–·é•·åº¦" class="w-full bg-white border p-3 rounded-xl font-bold s-part-l"></div>
            <div class="col-span-3"><input type="number" placeholder="æ•¸é‡" class="w-full bg-white border p-3 rounded-xl font-bold s-part-q"></div>
            <div class="col-span-1 flex justify-end"><button onclick="this.parentElement.parentElement.remove(); calculateSteel();" class="text-slate-300 hover:text-red-500 text-2xl">Ã—</button></div>`;
        container.appendChild(row);
        row.querySelectorAll('input, select').forEach(el => el.addEventListener('input', calculateSteel));
    }

    function calculateSteel() {
        const stockLen = parseFloat(document.getElementById('s-stock-len').value);
        let grouped = {}, totalW = 0;
        document.querySelectorAll('#s-input-rows .input-group').forEach(row => {
            const sel = row.querySelector('.s-part-spec');
            const kgm = parseFloat(sel.value);
            const name = sel.options[sel.selectedIndex].getAttribute('data-name');
            const L = parseFloat(row.querySelector('.s-part-l').value) || 0;
            const Q = parseInt(row.querySelector('.s-part-q').value) || 0;
            if(L > 0 && Q > 0) {
                totalW += (L/1000) * kgm * Q;
                if(!grouped[name]) grouped[name] = [];
                for(let i=0; i<Q; i++) grouped[name].push({ len: L });
            }
        });
        document.getElementById('s-total-weight').textContent = totalW.toFixed(2);
        renderSteel(grouped, stockLen);
    }

    function renderSteel(grouped, stockLen) {
        const out = document.getElementById('s-output'); out.innerHTML = "";
        let totalBars = 0;
        Object.keys(grouped).forEach(spec => {
            const res = nest1D(grouped[spec], stockLen);
            totalBars += res.length;
            const sec = document.createElement('div');
            sec.innerHTML = `<h2 class="text-2xl font-black mb-4 border-l-4 border-indigo-600 pl-4">${spec} é…æ–™æ–¹æ¡ˆ</h2>`;
            res.forEach((bar, bi) => {
                const used = bar.reduce((a,c)=>a+c.len, 0);
                const barDiv = document.createElement('div');
                barDiv.className = "bg-white p-6 rounded-2xl border mb-4";
                barDiv.innerHTML = `<p class="mb-2 font-bold">åŸæ–™æ”¯ #${bi+1} (å·²ç”¨: ${used}mm / å‰©é¤˜: ${stockLen-used}mm)</p><div class="stock-bar"></div>`;
                const vis = barDiv.querySelector('.stock-bar');
                bar.forEach(c => {
                    const seg = document.createElement('div');
                    seg.className = "cut-segment";
                    seg.style.width = `${(c.len/stockLen)*100}%`;
                    seg.style.backgroundColor = `hsl(${(c.len*123)%360}, 60%, 45%)`;
                    seg.innerHTML = `<span>${c.len}</span>`;
                    vis.appendChild(seg);
                });
                sec.appendChild(barDiv);
            });
            out.appendChild(sec);
        });
        document.getElementById('s-total-bars').textContent = totalBars;
    }

    // âœ… å‹é‹¼æ’æ–™æ ¸å¿ƒï¼šå·²æ•´åˆ 15mm é‹¸ç¸«è¨ˆç®—
    function nest1D(cuts, stockLen) {
        const KERF = 15; // çµ±ä¸€é‹¸ç¸«
        let sorted = [...cuts].sort((a,b)=>b.len - a.len);
        let bars = [];
        while(sorted.length > 0){
            let cur = [], rem = stockLen;
            for(let i=0; i<sorted.length; i++){
                // åˆ¤æ–·æ¢ä»¶ï¼šéœ€æ±‚é•·åº¦ + é‹¸ç¸«æè€— æ˜¯å¦ä»å°æ–¼ç­‰æ–¼å‰©é¤˜åŸæ–™é•·åº¦
                if(sorted[i].len + KERF <= rem || (sorted[i].len <= rem && cur.length === 0)){
                    cur.push(sorted[i]);
                    rem -= (sorted[i].len + KERF);
                    sorted.splice(i,1); i--;
                }
            }
            bars.push(cur);
        }
        return bars;
    }

    function toggleFormulaModal() { document.getElementById('formulaModal').classList.toggle('hidden'); }
</script>
</body>
</html>
